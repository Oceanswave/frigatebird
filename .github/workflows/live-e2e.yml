name: Live E2E

on:
  workflow_dispatch:
    inputs:
      list_name:
        description: "X list name used for add/remove/batch mutation checks"
        required: true
        type: string
      cookie_source:
        description: "Primary cookie source for live mutation commands"
        required: false
        default: "safari"
        type: string
      expected_handle_prefix:
        description: "Safety guard: authenticated handle must start with this prefix"
        required: false
        default: "frigatebird_"
        type: string
      target_handle:
        description: "Handle used for follow/list mutation checks"
        required: false
        default: "Oceanswave"
        type: string
      premium_features_e2e:
        description: "Run premium-feature live e2e checks (article mutation)"
        required: false
        default: false
        type: boolean
      article_cookie_source:
        description: "Cookie source used for article mutation checks"
        required: false
        default: "chrome"
        type: string
      article_expected_handle_prefix:
        description: "Safety guard prefix for article mutation account"
        required: false
        default: "Oceanswave"
        type: string
  schedule:
    - cron: "17 9 * * 1"

concurrency:
  group: live-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  live-mutation:
    name: Live Mutation Coverage
    if: github.event_name != 'schedule' || vars.FRIGATEBIRD_ENABLE_SCHEDULED_LIVE_E2E == '1'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FRIGATEBIRD_LIVE_E2E: "1"
      FRIGATEBIRD_LIVE_EXPECTED_HANDLE_PREFIX: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.expected_handle_prefix || vars.FRIGATEBIRD_LIVE_E2E_EXPECTED_HANDLE_PREFIX || 'frigatebird_' }}
      FRIGATEBIRD_LIVE_TARGET_HANDLE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_handle || vars.FRIGATEBIRD_LIVE_E2E_TARGET_HANDLE || 'Oceanswave' }}
      FRIGATEBIRD_AUTH_TOKEN: ${{ secrets.FRIGATEBIRD_AUTH_TOKEN }}
      FRIGATEBIRD_CT0: ${{ secrets.FRIGATEBIRD_CT0 }}
      NO_COLOR: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm

      - name: Resolve live mutation inputs
        run: |
          LIST_NAME="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.list_name || vars.FRIGATEBIRD_LIVE_E2E_LIST_NAME }}"
          COOKIE_SOURCE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.cookie_source || vars.FRIGATEBIRD_LIVE_E2E_COOKIE_SOURCE || 'safari' }}"
          PREMIUM_FEATURES_E2E="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.premium_features_e2e || vars.FRIGATEBIRD_LIVE_E2E_PREMIUM || 'false' }}"
          ARTICLE_COOKIE_SOURCE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.article_cookie_source || vars.FRIGATEBIRD_LIVE_E2E_ARTICLE_COOKIE_SOURCE || 'chrome' }}"
          ARTICLE_EXPECTED_HANDLE_PREFIX="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.article_expected_handle_prefix || vars.FRIGATEBIRD_LIVE_E2E_ARTICLE_EXPECTED_HANDLE_PREFIX || 'Oceanswave' }}"

          echo "LIVE_LIST_NAME=$LIST_NAME" >> "$GITHUB_ENV"
          echo "LIVE_COOKIE_SOURCE=$COOKIE_SOURCE" >> "$GITHUB_ENV"
          echo "LIVE_PREMIUM_FEATURES_E2E=$PREMIUM_FEATURES_E2E" >> "$GITHUB_ENV"
          echo "LIVE_ARTICLE_COOKIE_SOURCE=$ARTICLE_COOKIE_SOURCE" >> "$GITHUB_ENV"
          echo "LIVE_ARTICLE_EXPECTED_HANDLE_PREFIX=$ARTICLE_EXPECTED_HANDLE_PREFIX" >> "$GITHUB_ENV"

      - name: Validate live mutation inputs
        run: |
          missing=0

          if [ -z "$FRIGATEBIRD_AUTH_TOKEN" ]; then
            echo "Missing required secret: FRIGATEBIRD_AUTH_TOKEN"
            missing=1
          fi

          if [ -z "$FRIGATEBIRD_CT0" ]; then
            echo "Missing required secret: FRIGATEBIRD_CT0"
            missing=1
          fi

          if [ -z "$LIVE_LIST_NAME" ]; then
            echo "Missing list name. Provide workflow_dispatch input list_name or set repo variable FRIGATEBIRD_LIVE_E2E_LIST_NAME for scheduled runs."
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run live mutation e2e
        run: |
          args=(
            --list-name "$LIVE_LIST_NAME"
            --cookie-source "$LIVE_COOKIE_SOURCE"
          )

          if [ "$LIVE_PREMIUM_FEATURES_E2E" = "true" ] || [ "$LIVE_PREMIUM_FEATURES_E2E" = "1" ]; then
            args+=(
              --enable-premium-features-e2e
              --article-cookie-source "$LIVE_ARTICLE_COOKIE_SOURCE"
              --article-expected-handle-prefix "$LIVE_ARTICLE_EXPECTED_HANDLE_PREFIX"
            )
          fi

          npm run test:e2e:live -- "${args[@]}"
